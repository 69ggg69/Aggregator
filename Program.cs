using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using System.Net.Http;
using System.Net;
using Aggregator.Data;
using Aggregator.Services;
using Aggregator.ParserServices;
using Aggregator.Interfaces;
using Aggregator.Extensions;
using Aggregator.Services.Application;

namespace Aggregator
{
    class Program
    {
        static async Task Main(string[] args)
        {
            var host = CreateHostBuilder(args).Build();
            
            try
            {
                var logger = host.Services.GetRequiredService<ILogger<Program>>();
                logger.LogInformation("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Aggregator —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –º–µ–Ω—é (–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–º API)
                await ShowMainMenuAsync(host, logger);
            }
            catch (Exception ex)
            {
                var logger = host.Services.GetRequiredService<ILogger<Program>>();
                logger.LogError(ex, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
                throw;
            }
        }

        static async Task ShowMainMenuAsync(IHost host, ILogger logger)
        {
            while (true)
            {
                Console.WriteLine("\n=== Aggregator - Product Parser ===");
                Console.WriteLine("1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥");
                Console.WriteLine("2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î");
                Console.WriteLine("3. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É");
                Console.WriteLine("0. –í—ã—Ö–æ–¥");
                Console.Write("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ");

                var choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await RunParsingAsync(host, logger);
                        break;
                    case "2":
                        await CheckDatabaseConnectionAsync(host, logger);
                        break;
                    case "3":
                        await ShowStatisticsAsync(host, logger);
                        break;
                    case "0":
                        logger.LogInformation("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
                        return;
                    default:
                        Console.WriteLine("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                        break;
                }
            }
        }

        static async Task RunParsingAsync(IHost host, ILogger logger)
        {
            try
            {
                logger.LogInformation("–ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
                var parsingService = host.Services.GetRequiredService<ParsingApplicationService>();
                await parsingService.RunParsingAsync();
                logger.LogInformation("–ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω");
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞");
                Console.WriteLine($"–û—à–∏–±–∫–∞: {ex.Message}");
            }
        }

        static async Task CheckDatabaseConnectionAsync(IHost host, ILogger logger)
        {
            try
            {
                using var scope = host.Services.CreateScope();
                var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
                
                Console.WriteLine("üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");
                
                // –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ–π SQL –∑–∞–ø—Ä–æ—Å
                var startTime = DateTime.Now;
                await dbContext.Database.ExecuteSqlRawAsync("SELECT 1");
                var endTime = DateTime.Now;
                var responseTime = (endTime - startTime).TotalMilliseconds;
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
                var productsCount = await dbContext.Products.CountAsync();
                
                Console.WriteLine("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ");
                Console.WriteLine($"   –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: {responseTime:F2} –º—Å");
                Console.WriteLine($"   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î: {productsCount}");
                
                logger.LogInformation("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î - —É—Å–ø–µ—à–Ω–æ. –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: {ResponseTime}ms, —Ç–æ–≤–∞—Ä–æ–≤: {ProductsCount}", 
                    responseTime, productsCount);
            }
            catch (Npgsql.NpgsqlException pgEx)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {pgEx.Message}");
                if (pgEx.Message.Contains("No connection could be made") || 
                    pgEx.Message.Contains("Connection refused") ||
                    pgEx.Message.Contains("could not connect to server"))
                {
                    Console.WriteLine("   üí° –í–æ–∑–º–æ–∂–Ω–æ, Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω");
                    Console.WriteLine("   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: docker-compose up -d postgres");
                }
                logger.LogError(pgEx, "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL");
            }
            catch (System.Net.Sockets.SocketException sockEx)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {sockEx.Message}");
                Console.WriteLine("   üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ—Ä—Ç 5432 –¥–æ—Å—Ç—É–ø–µ–Ω");
                logger.LogError(sockEx, "–û—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
            }
            catch (TimeoutException timeEx)
            {
                Console.WriteLine($"‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {timeEx.Message}");
                Console.WriteLine("   üí° –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞");
                logger.LogError(timeEx, "–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {ex.Message}");
                Console.WriteLine($"   –¢–∏–ø –æ—à–∏–±–∫–∏: {ex.GetType().Name}");
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"   –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {ex.InnerException.Message}");
                }
                
                logger.LogError(ex, "–û–±—â–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
            }
        }

        static async Task ShowStatisticsAsync(IHost host, ILogger logger)
        {
            try
            {
                var parsingService = host.Services.GetRequiredService<ParsingApplicationService>();
                var statistics = await parsingService.GetStatisticsAsync();

                Console.WriteLine($"\nüìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:");
                Console.WriteLine($"   –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î: {statistics.TotalProducts}");
                Console.WriteLine($"   –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥: {(statistics.LastParseDate?.ToString("dd.MM.yyyy HH:mm") ?? "–ù–µ –±—ã–ª–æ")}");
                
                if (statistics.ShopStatistics.Count > 0)
                {
                    Console.WriteLine("\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º:");
                    foreach (var shopStat in statistics.ShopStatistics)
                    {
                        Console.WriteLine($"   {shopStat.ShopName}: {shopStat.ProductCount} —Ç–æ–≤–∞—Ä–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ: {shopStat.LastUpdate:dd.MM.yyyy HH:mm})");
                    }
                }
                
                logger.LogInformation("–ü–æ–∫–∞–∑–∞–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Ç–æ–≤–∞—Ä–æ–≤ {TotalProducts}, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥ {LastParseDate}", 
                    statistics.TotalProducts, statistics.LastParseDate);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {ex.Message}");
                logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏");
            }
        }

        static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration((context, config) =>
                {
                    config.AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);
                    config.AddJsonFile($"appsettings.{context.HostingEnvironment.EnvironmentName}.json", 
                                     optional: true, reloadOnChange: true);
                })
                .ConfigureServices((context, services) =>
                {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º extension –º–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
                    services.AddAggregatorServices(context.Configuration);
                })
                .ConfigureLogging((context, logging) =>
                {
                    logging.ClearProviders();
                    logging.AddConsole();
                    logging.AddDebug();
                    logging.SetMinimumLevel(LogLevel.Information);
                });
    }
}
