# Use the official .NET 8.0 SDK image for migrations
FROM mcr.microsoft.com/dotnet/sdk:8.0
WORKDIR /app

# Install Entity Framework tools
RUN dotnet tool install --global dotnet-ef
ENV PATH="$PATH:/root/.dotnet/tools"

# Copy project files
COPY *.csproj ./
RUN dotnet restore

# Copy everything else
COPY . ./

# Set environment to use Docker configuration
ENV ASPNETCORE_ENVIRONMENT=Docker

# Create a simple and reliable migration script
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ðŸ”„ Starting database migration process..."\n\
echo "Connection: $1"\n\
\n\
# Validate connection string\n\
if [ -z "$1" ]; then\n\
  echo "âŒ No connection string provided!"\n\
  exit 1\n\
fi\n\
\n\
# Wait for database to be ready\n\
echo "â³ Waiting for database to be fully ready..."\n\
sleep 5\n\
\n\
# Build the project (restore was already done in Docker build)\n\
echo "ðŸ”¨ Building project..."\n\
dotnet build\n\
\n\
# List what EF finds (for debugging)\n\
echo "ðŸ” Checking what EF tools find..."\n\
dotnet ef dbcontext list --verbose || echo "Context listing failed"\n\
\n\
# Run migrations with explicit connection string\n\
echo "ðŸ”„ Running migrations..."\n\
dotnet ef database update --connection "$1" --verbose\n\
\n\
echo "âœ… Migrations completed successfully!"' > /app/migrate.sh && chmod +x /app/migrate.sh

# Default entrypoint that accepts connection string as argument
ENTRYPOINT ["/app/migrate.sh"] 